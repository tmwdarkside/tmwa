From 59669619318ba453ee9bd2f9691176da6a4007ae Mon Sep 17 00:00:00 2001
From: Andrei Karas <akaras@inbox.ru>
Date: Sat, 4 Dec 2010 22:37:28 +0200
Subject: [PATCH 082/226] Last part adding cppcheck fixes.

---
 src/map/pc.c     | 79 ++++++++++++++++++++++++++++++++++----------------------
 src/map/script.c | 58 ++++++++++++++++++++++++++++-------------
 src/map/skill.c  | 70 ++++++++++++++++++++++++++-----------------------
 src/map/trade.c  | 19 +++++++-------
 4 files changed, 134 insertions(+), 92 deletions(-)

diff --git a/src/map/pc.c b/src/map/pc.c
index d218ba9..9851793 100644
--- a/src/map/pc.c
+++ b/src/map/pc.c
@@ -153,6 +153,11 @@ int pc_set_gm_level (int account_id, int level)
 
     GM_num++;
     gm_account = realloc (gm_account, sizeof (struct gm_account) * GM_num);
+    if (!gm_account)
+    {
+        printf("out of memory pc_set_gm_level\n");
+        exit(1);
+    }
     gm_account[GM_num - 1].account_id = account_id;
     gm_account[GM_num - 1].level = level;
     return 0;
@@ -262,8 +267,6 @@ static int pc_spiritball_timer (int tid, unsigned int tick __attribute__ ((unuse
 
 int pc_addspiritball (struct map_session_data *sd, int interval, int max)
 {
-    int  i;
-
     nullpo_retr (0, sd);
 
     if (max > MAX_SKILL_LEVEL)
@@ -273,6 +276,8 @@ int pc_addspiritball (struct map_session_data *sd, int interval, int max)
 
     if (sd->spiritball >= max)
     {
+        int  i;
+
         if (sd->spirit_timer[0] != -1)
         {
             delete_timer (sd->spirit_timer[0], pc_spiritball_timer);
@@ -789,8 +794,8 @@ int pc_authok (int id, int login_id2, time_t connect_until_time,
 {
     struct map_session_data *sd = NULL;
 
-    struct party *p;
-    struct guild *g;
+//    struct party *p;
+//    struct guild *g;
     int  i;
     unsigned long tick = gettick ();
     struct sockaddr_in sai;
@@ -920,10 +925,10 @@ int pc_authok (int id, int login_id2, time_t connect_until_time,
 
     // ï¿½pï¿½[ï¿½eï¿½Bï¿½Aï¿½Mï¿½ï¿½ï¿½hï¿½fï¿½[ï¿½^ï¿½Ì—vï¿½ï¿½
     if (sd->status.party_id > 0
-        && (p = party_search (sd->status.party_id)) == NULL)
+        && party_search (sd->status.party_id) == NULL)
         party_request_info (sd->status.party_id);
     if (sd->status.guild_id > 0
-        && (g = guild_search (sd->status.guild_id)) == NULL)
+        && guild_search (sd->status.guild_id) == NULL)
         guild_request_info (sd->status.guild_id);
 
     // pvpï¿½Ìİ’ï¿½
@@ -1052,7 +1057,7 @@ static int pc_calc_skillpoint (struct map_session_data *sd)
  */
 int pc_calc_skilltree (struct map_session_data *sd)
 {
-    int  i, id = 0, flag;
+    int  i, id = 0;
     int  c = 0, s = 0;
     //ï¿½]ï¿½ï¿½ï¿½ï¿½ï¿½{ï¿½qï¿½Ìê‡ï¿½ÌŒï¿½ï¿½ÌEï¿½Æ‚ï¿½ï¿½Zï¿½oï¿½ï¿½ï¿½ï¿½
     struct pc_base_job s_class;
@@ -1188,15 +1193,17 @@ int pc_calc_skilltree (struct map_session_data *sd)
     }
     else
     {
+        int  flag;
         // ï¿½Êï¿½ï¿½ÌŒvï¿½Z
         do
         {
             flag = 0;
             for (i = 0; (id = skill_tree[s][c][i].id) > 0; i++)
             {
-                int  j, f = 1;
+                int  f = 1;
                 if (!battle_config.skillfree)
                 {
+                    int  j;
                     for (j = 0; j < 5; j++)
                     {
                         if (skill_tree[s][c][i].need[j].id &&
@@ -3676,7 +3683,6 @@ static int can_pick_item_up_from (struct map_session_data *self, int other_id)
 
 int pc_takeitem (struct map_session_data *sd, struct flooritem_data *fitem)
 {
-    int  flag;
     unsigned int tick = gettick ();
     int  can_take;
 
@@ -3711,6 +3717,7 @@ int pc_takeitem (struct map_session_data *sd, struct flooritem_data *fitem)
     {
         /* Can pick up */
 
+        int  flag;
         if ((flag =
              pc_additem (sd, &fitem->item_data, fitem->item_data.amount)))
             // ï¿½dï¿½ï¿½overï¿½Åæ“¾ï¿½ï¿½ï¿½s
@@ -3776,16 +3783,13 @@ int pc_isUseitem (struct map_session_data *sd, int n)
  */
 int pc_useitem (struct map_session_data *sd, int n)
 {
-    int  nameid, amount;
-
     nullpo_retr (1, sd);
 
     if (n >= 0 && n < MAX_INVENTORY && sd->inventory_data[n])
     {
-        nameid = sd->status.inventory[n].nameid;
-        amount = sd->status.inventory[n].amount;
+        const int amount = sd->status.inventory[n].amount;
         if (sd->status.inventory[n].nameid <= 0
-            || sd->status.inventory[n].amount <= 0
+            || amount <= 0
             || sd->sc_data[SC_BERSERK].timer != -1 || !pc_isUseitem (sd, n))
         {
             clif_useitemack (sd, n, 0, 0);
@@ -4047,11 +4051,11 @@ int pc_steal_item (struct map_session_data *sd, struct block_list *bl)
 {
     if (sd != NULL && bl != NULL && bl->type == BL_MOB)
     {
-        int  i, skill, rate, itemid, flag, count;
         struct mob_data *md;
         md = (struct mob_data *) bl;
         if (!md->state.steal_flag && mob_db[md->class].mexp <= 0 && !(mob_db[md->class].mode & 0x20) && md->sc_data[SC_STONE].timer == -1 && md->sc_data[SC_FREEZE].timer == -1 && (!(md->class > 1324 && md->class < 1364)))   // prevent stealing from treasure boxes [Valaris]
         {
+            int  skill;
             skill =
                 sd->paramc[4] - mob_db[md->class].dex + pc_checkskill (sd,
                                                                        TF_STEAL)
@@ -4059,6 +4063,7 @@ int pc_steal_item (struct map_session_data *sd, struct block_list *bl)
 
             if (0 < skill)
             {
+                int  i, rate, itemid, flag, count;
                 for (count = 8; count <= 8 && count != 0; count--)
                 {
                     i = rand () % 8;
@@ -4115,12 +4120,12 @@ int pc_steal_coin (struct map_session_data *sd, struct block_list *bl)
 {
     if (sd != NULL && bl != NULL && bl->type == BL_MOB)
     {
-        int  rate, skill;
         struct mob_data *md = (struct mob_data *) bl;
         if (md && !md->state.steal_coin_flag && md->sc_data
             && md->sc_data[SC_STONE].timer == -1
             && md->sc_data[SC_FREEZE].timer == -1)
         {
+            int  rate, skill;
             skill = pc_checkskill (sd, RG_STEALCOIN) * 10;
             rate =
                 skill + (sd->status.base_level - mob_db[md->class].lv) * 3 +
@@ -4425,9 +4430,7 @@ static int calc_next_walk_step (struct map_session_data *sd)
 static int pc_walk (int tid, unsigned int tick, int id, int data)
 {
     struct map_session_data *sd;
-    int  i, ctype;
-    int  moveblock;
-    int  x, y, dx, dy;
+    int  i;
 
     sd = map_id2sd (id);
     if (sd == NULL)
@@ -4460,6 +4463,9 @@ static int pc_walk (int tid, unsigned int tick, int id, int data)
     }
     else
     {                           // ï¿½}ï¿½Xï¿½Ú‹ï¿½ï¿½Eï¿½Ö“ï¿½ï¿½ï¿½
+        int  ctype;
+        int  moveblock;
+        int  x, y, dx, dy;
         if (sd->walkpath.path[sd->walkpath.path_pos] >= 8)
             return 1;
 
@@ -4905,7 +4911,6 @@ int pc_attack_timer (int tid, unsigned int tick, int id,
     struct block_list *bl;
     struct status_change *sc_data;
     short *opt;
-    int  dist, skill, range;
     int  attack_spell_delay;
 
     sd = map_id2sd (id);
@@ -4983,6 +4988,7 @@ int pc_attack_timer (int tid, unsigned int tick, int id,
     }
     else
     {
+        int  dist, range;
         dist = distance (sd->bl.x, sd->bl.y, bl->x, bl->y);
         range = sd->attackrange;
         if (sd->status.weapon != 11)
@@ -5006,6 +5012,8 @@ int pc_attack_timer (int tid, unsigned int tick, int id,
         }
         else
         {
+            int  skill;
+
             if (battle_config.pc_attack_direction_change)
                 sd->dir = sd->head_dir = map_calc_dir (&sd->bl, bl->x, bl->y);  // ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
 
@@ -5022,6 +5030,7 @@ int pc_attack_timer (int tid, unsigned int tick, int id,
                     && sd->sc_data[SC_CLOAKING].timer != -1)
                     skill_status_change_end (&sd->bl, SC_CLOAKING, -1);
                 map_freeblock_unlock ();
+
                 if (sd->skilltimer != -1 && (skill = pc_checkskill (sd, SA_FREECAST)) > 0)  // ï¿½tï¿½ï¿½ï¿½[ï¿½Lï¿½ï¿½ï¿½Xï¿½g
                     sd->attackabletime =
                         tick + ((sd->aspd << 1) * (150 - skill * 5) / 100);
@@ -5030,7 +5039,7 @@ int pc_attack_timer (int tid, unsigned int tick, int id,
             }
             else if (sd->attackabletime <= tick)
             {
-                if (sd->skilltimer != -1 && (skill = pc_checkskill (sd, SA_FREECAST)) > 0)  // ï¿½tï¿½ï¿½ï¿½[ï¿½Lï¿½ï¿½ï¿½Xï¿½g
+                if (sd->skilltimer != -1 && (skill = pc_checkskill (sd, SA_FREECAST)) > 0)
                     sd->attackabletime =
                         tick + ((sd->aspd << 1) * (150 - skill * 5) / 100);
                 else
@@ -5926,14 +5935,14 @@ int pc_resetstate (struct map_session_data *sd)
  */
 int pc_resetskill (struct map_session_data *sd)
 {
-    int  i, skill;
+    int  i;
 
     nullpo_retr (0, sd);
 
     sd->status.skill_point += pc_calc_skillpoint (sd);
 
     for (i = 1; i < MAX_SKILL; i++)
-        if ((skill = pc_checkskill (sd, i)) > 0)
+        if (pc_checkskill (sd, i) > 0)
         {
             sd->status.skill[i].lv = 0;
             sd->status.skill[i].flags = 0;
@@ -6136,12 +6145,12 @@ int pc_damage (struct block_list *src, struct map_session_data *sd,
                 //ï¿½æ‚¸ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½Aï¿½Cï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½Eï¿½ï¿½ï¿½g
                 for (i = 0; i < MAX_INVENTORY; i++)
                 {
-                    int  k;
                     if ((type == 1 && !sd->status.inventory[i].equip)
                         || (type == 2 && sd->status.inventory[i].equip)
                         || type == 3)
                     {
                         //InventoryIndexï¿½ï¿½ï¿½iï¿½[
+                        int  k;
                         for (k = 0; k < MAX_INVENTORY; k++)
                         {
                             if (eq_n[k] <= 0)
@@ -8139,7 +8148,7 @@ static int pc_hpheal (struct map_session_data *sd)
 static int pc_natural_heal_hp (struct map_session_data *sd)
 {
     int  bhp;
-    int  inc_num, bonus, skill, hp_flag;
+    int  inc_num, bonus, hp_flag;
 
     nullpo_retr (0, sd);
 
@@ -8234,6 +8243,7 @@ static int pc_natural_heal_hp (struct map_session_data *sd)
 
     return 0;
 
+/*
     if (sd->sc_data[SC_APPLEIDUN].timer != -1)
     {                           // Apple of Idun
         if (sd->inchealhptick >= 6000 && sd->status.hp < sd->status.max_hp)
@@ -8258,6 +8268,7 @@ static int pc_natural_heal_hp (struct map_session_data *sd)
         sd->inchealhptick = 0;
 
     return 0;
+*/
 }
 
 static int pc_natural_heal_sp (struct map_session_data *sd)
@@ -8343,7 +8354,7 @@ static int pc_spirit_heal_hp (struct map_session_data *sd, int level __attribute
 {
     nullpo_retr (0, sd);
 
-    int  bonus_hp, interval = battle_config.natural_heal_skill_interval;
+    int  interval = battle_config.natural_heal_skill_interval;;
     struct status_change *sc_data = battle_get_sc_data (&sd->bl);
     nullpo_retr (0, sc_data);
 
@@ -8362,6 +8373,7 @@ static int pc_spirit_heal_hp (struct map_session_data *sd, int level __attribute
 
     if (sd->inchealspirithptick >= interval)
     {
+        int  bonus_hp;
         bonus_hp = sd->nsshealhp;
         while (sd->inchealspirithptick >= interval)
         {
@@ -8394,7 +8406,7 @@ static int pc_spirit_heal_hp (struct map_session_data *sd, int level __attribute
 
 static int pc_spirit_heal_sp (struct map_session_data *sd, int level __attribute__ ((unused)))
 {
-    int  bonus_sp, interval = battle_config.natural_heal_skill_interval;
+    int  interval = battle_config.natural_heal_skill_interval;
 
     nullpo_retr (0, sd);
 
@@ -8412,6 +8424,7 @@ static int pc_spirit_heal_sp (struct map_session_data *sd, int level __attribute
 
     if (sd->inchealspiritsptick >= interval)
     {
+        int  bonus_sp;
         bonus_sp = sd->nsshealsp;
         while (sd->inchealspiritsptick >= interval)
         {
@@ -8655,12 +8668,16 @@ int pc_autosave (int tid __attribute__ ((unused)), unsigned int tick __attribute
 int pc_read_gm_account (int fd)
 {
     int  i = 0;
-    if (gm_account != NULL)
-        free (gm_account);
+    free (gm_account);
     GM_num = 0;
 
     gm_account =
         calloc (sizeof (struct gm_account) * ((RFIFOW (fd, 2) - 4) / 5), 1);
+    if (!gm_account)
+    {
+        printf("out of memory pc_read_gm_account\n");
+        exit(1);
+    }
     for (i = 4; i < RFIFOW (fd, 2); i = i + 5)
     {
         gm_account[GM_num].account_id = RFIFOL (fd, i);
@@ -8678,13 +8695,13 @@ int pc_read_gm_account (int fd)
 int map_day_timer (int tid __attribute__ ((unused)), unsigned int tick __attribute__ ((unused)), int id __attribute__ ((unused)), int data __attribute__ ((unused)))
 {                               // by [yor]
     struct map_session_data *pl_sd = NULL;
-    int  i;
     char tmpstr[1024];
 
     if (battle_config.day_duration > 0)
     {                           // if we want a day
         if (night_flag != 0)
         {
+            int  i;
             strcpy (tmpstr, msg_txt (502)); // The day has arrived!
             night_flag = 0;     // 0=day, 1=night [Yor]
             for (i = 0; i < fd_max; i++)
@@ -8711,13 +8728,13 @@ int map_day_timer (int tid __attribute__ ((unused)), unsigned int tick __attribu
 int map_night_timer (int tid __attribute__ ((unused)), unsigned int tick __attribute__ ((unused)), int id __attribute__ ((unused)), int data __attribute__ ((unused)))
 {                               // by [yor]
     struct map_session_data *pl_sd = NULL;
-    int  i;
     char tmpstr[1024];
 
     if (battle_config.night_duration > 0)
     {                           // if we want a night
         if (night_flag == 0)
         {
+            int  i;
             strcpy (tmpstr, msg_txt (503)); // The night has fallen...
             night_flag = 1;     // 0=day, 1=night [Yor]
             for (i = 0; i < fd_max; i++)
diff --git a/src/map/script.c b/src/map/script.c
index 347937c..e5f136b 100644
--- a/src/map/script.c
+++ b/src/map/script.c
@@ -1099,7 +1099,6 @@ unsigned char *parse_simpleexpr (unsigned char *p)
     if (!p)
         return 0;
 
-    int  i;
     p = skip_space (p);
 
 #ifdef DEBUG_FUNCIN
@@ -1125,6 +1124,7 @@ unsigned char *parse_simpleexpr (unsigned char *p)
     else if (isdigit (*p) || ((*p == '-' || *p == '+') && isdigit (p[1])))
     {
         char *np;
+        int  i;
         i = strtoul (p, &np, 0);
         add_scripti (i);
         p = np;
@@ -1935,6 +1935,7 @@ void pop_stack (struct script_stack *stack, int start, int end)
         if (stack->stack_data[i].type == C_STR)
         {
             free (stack->stack_data[i].u.str);
+            stack->stack_data[i].u.str = 0;
         }
     }
     if (stack->sp > end)
@@ -2149,6 +2150,7 @@ int buildin_menu (struct script_state *st)
         }
         clif_scriptmenu (script_rid2sd (st), st->oid, buf);
         free (buf);
+        buf = 0;
     }
     else if (sd->npc_menu == 0xff)
     {                           // cansel
@@ -2188,10 +2190,11 @@ int buildin_menu (struct script_state *st)
  */
 int buildin_rand (struct script_state *st)
 {
-    int  range, min, max;
+    int  range;
 
     if (st->end > st->start + 3)
     {
+        int  min, max;
         min = conv_num (st, &(st->stack->stack_data[st->start + 2]));
         max = conv_num (st, &(st->stack->stack_data[st->start + 3]));
         if (max < min)
@@ -2802,7 +2805,7 @@ int buildin_viewpoint (struct script_state *st)
  */
 int buildin_countitem (struct script_state *st)
 {
-    int  nameid = 0, count = 0, i;
+    int  nameid = 0, count = 0;
     struct map_session_data *sd;
 
     struct script_data *data;
@@ -2822,11 +2825,14 @@ int buildin_countitem (struct script_state *st)
         nameid = conv_num (st, data);
 
     if (nameid >= 500)          //if no such ID then skip this iteration
+    {
+        int  i;
         for (i = 0; i < MAX_INVENTORY; i++)
         {
             if (sd->status.inventory[i].nameid == nameid)
                 count += sd->status.inventory[i].amount;
         }
+    }
     else
     {
         if (battle_config.error_log)
@@ -3259,13 +3265,14 @@ int buildin_getpartyname (struct script_state *st)
 int buildin_getpartymember (struct script_state *st)
 {
     struct party *p;
-    int  i, j = 0;
+    int  j = 0;
 
     p = NULL;
     p = party_search (conv_num (st, &(st->stack->stack_data[st->start + 2])));
 
     if (p != NULL)
     {
+        int  i;
         for (i = 0; i < MAX_PARTY; i++)
         {
             if (p->member[i].account_id)
@@ -3680,7 +3687,7 @@ int buildin_getequippercentrefinery (struct script_state *st)
  */
 int buildin_successrefitem (struct script_state *st)
 {
-    int  i, num, ep;
+    int  i, num;
     struct map_session_data *sd;
 
     num = conv_num (st, &(st->stack->stack_data[st->start + 2]));
@@ -3688,6 +3695,7 @@ int buildin_successrefitem (struct script_state *st)
     i = pc_checkequip (sd, equip[num - 1]);
     if (i >= 0)
     {
+        int  ep;
         ep = sd->status.inventory[i].equip;
 
         sd->status.inventory[i].refine++;
@@ -5593,7 +5601,7 @@ int buildin_removemapflag (struct script_state *st)
 
 int buildin_pvpon (struct script_state *st)
 {
-    int  m, i;
+    int  m;
     char *str;
     struct map_session_data *pl_sd = NULL;
 
@@ -5601,6 +5609,7 @@ int buildin_pvpon (struct script_state *st)
     m = map_mapname2mapid (str);
     if (m >= 0 && !map[m].flag.pvp && !map[m].flag.nopvp)
     {
+        int  i;
         map[m].flag.pvp = 1;
         clif_send0199 (m, 1);
 
@@ -5630,7 +5639,7 @@ int buildin_pvpon (struct script_state *st)
 
 int buildin_pvpoff (struct script_state *st)
 {
-    int  m, i;
+    int  m;
     char *str;
     struct map_session_data *pl_sd = NULL;
 
@@ -5644,6 +5653,7 @@ int buildin_pvpoff (struct script_state *st)
         if (battle_config.pk_mode)  // disable ranking options if pk_mode is on [Valaris]
             return 0;
 
+        int  i;
         for (i = 0; i < fd_max; i++)
         {                       //ï¿½lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½v
             if (session[i] && (pl_sd = session[i]->session_data)
@@ -6951,8 +6961,9 @@ int buildin_gmcommand (struct script_state *st)
  *------------------------------------------
  */
 
-int buildin_movenpc (struct script_state *st)
+int buildin_movenpc (struct script_state *st __attribute__ ((unused)))
 {
+/*
     struct map_session_data *sd;
     char *map, *npc;
     int  x, y;
@@ -6963,6 +6974,7 @@ int buildin_movenpc (struct script_state *st)
     x = conv_num (st, &(st->stack->stack_data[st->start + 3]));
     y = conv_num (st, &(st->stack->stack_data[st->start + 4]));
     npc = conv_str (st, &(st->stack->stack_data[st->start + 5]));
+*/
 
     return 0;
 }
@@ -7392,9 +7404,15 @@ void op_add (struct script_state *st)
         strcpy (buf, st->stack->stack_data[st->stack->sp - 1].u.str);
         strcat (buf, st->stack->stack_data[st->stack->sp].u.str);
         if (st->stack->stack_data[st->stack->sp - 1].type == C_STR)
+        {
             free (st->stack->stack_data[st->stack->sp - 1].u.str);
+            st->stack->stack_data[st->stack->sp - 1].u.str = 0;
+        }
         if (st->stack->stack_data[st->stack->sp].type == C_STR)
+        {
             free (st->stack->stack_data[st->stack->sp].u.str);
+            st->stack->stack_data[st->stack->sp].u.str = 0;
+        }
         st->stack->stack_data[st->stack->sp - 1].type = C_STR;
         st->stack->stack_data[st->stack->sp - 1].u.str = buf;
     }
@@ -7807,11 +7825,15 @@ int run_script_main (unsigned char *script, int pos,
         struct map_session_data *sd = map_id2sd (st->rid);
         if (sd /* && sd->npc_stackbuf==NULL */ )
         {
-            if (sd->npc_stackbuf)
-                free (sd->npc_stackbuf);
+            free (sd->npc_stackbuf);
             sd->npc_stackbuf =
                 (char *) aCalloc (sizeof (stack->stack_data[0]) *
                                   stack->sp_max, sizeof (char));
+            if (!sd->npc_stackbuf)
+            {
+                printf("out of memory run_script_main");
+                exit(1);
+            }
             memcpy (sd->npc_stackbuf, stack->stack_data,
                     sizeof (stack->stack_data[0]) * stack->sp_max);
             sd->npc_stack = stack->sp;
@@ -7908,8 +7930,8 @@ int mapreg_setregstr (int num, const char *str)
 {
     char *p;
 
-    if ((p = numdb_search (mapregstr_db, num)) != NULL)
-        free (p);
+    p = numdb_search (mapregstr_db, num);
+    free (p);
 
     if (str == NULL || *str == 0)
     {
@@ -8142,8 +8164,8 @@ int do_final_script ()
 {
     if (mapreg_dirty >= 0)
         script_save_mapreg ();
-    if (script_buf)
-        free (script_buf);
+    free (script_buf);
+    script_buf = 0;
 
     if (mapreg_db)
         numdb_final (mapreg_db, mapreg_db_final);
@@ -8154,10 +8176,10 @@ int do_final_script ()
     if (userfunc_db)
         strdb_final (userfunc_db, userfunc_db_final);
 
-    if (str_data)
-        free (str_data);
-    if (str_buf)
-        free (str_buf);
+    free (str_data);
+    str_data = 0;
+    free (str_buf);
+    str_buf = 0;
 
     return 0;
 }
diff --git a/src/map/skill.c b/src/map/skill.c
index 00c7226..f3f2bf3 100644
--- a/src/map/skill.c
+++ b/src/map/skill.c
@@ -1110,7 +1110,6 @@ int skill_additional_effect (struct block_list *src, struct block_list *bl,
     struct map_session_data *sd = NULL;
     struct map_session_data *dstsd = NULL;
     struct mob_data *md = NULL;
-    struct mob_data *dstmd = NULL;
 
     int  skill, skill2;
     int  rate, luk;
@@ -1155,7 +1154,7 @@ int skill_additional_effect (struct block_list *src, struct block_list *bl,
         dstsd = (struct map_session_data *) bl;
     else if (bl->type == BL_MOB)
     {
-        dstmd = (struct mob_data *) bl; //–¢g—pH
+//        dstmd = (struct mob_data *) bl;
         if (sc_def_mdef > 50)
             sc_def_mdef = 50;
         if (sc_def_vit > 50)
@@ -2330,7 +2329,6 @@ static int skill_timerskill (int tid __attribute__ ((unused)),
     struct mob_data *md = NULL;
     struct block_list *src = map_id2bl (id), *target;
     struct skill_timerskill *skl = NULL;
-    int  range;
 
     nullpo_retr (0, src);
 
@@ -2356,6 +2354,7 @@ static int skill_timerskill (int tid __attribute__ ((unused)),
     skl->timer = -1;
     if (skl->target_id)
     {
+        int  range;
         struct block_list tbl;
         target = map_id2bl (skl->target_id);
         if (skl->skill_id == RG_INTIMIDATE)
@@ -3253,8 +3252,7 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
     struct mob_data *dstmd = NULL;
     int  i;
     int  sc_def_vit, sc_def_mdef, strip_fix, strip_time, strip_per;
-    int  sc_dex, sc_luk;
-    //ƒNƒ‰ƒXƒ`ƒFƒ“ƒW—pƒ{ƒXƒ‚ƒ“ƒXƒ^[ID
+
     int  changeclass[] =
         { 1038, 1039, 1046, 1059, 1086, 1087, 1112, 1115, 1157, 1159, 1190,
         1272, 1312, 1373, 1492
@@ -3269,8 +3267,8 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
     else if (src->type == BL_MOB)
         md = (struct mob_data *) src;
 
-    sc_dex = battle_get_mdef (bl);
-    sc_luk = battle_get_luk (bl);
+//    sc_dex = battle_get_mdef (bl);
+//    sc_luk = battle_get_luk (bl);
     sc_def_vit = 100 - (3 + battle_get_vit (bl) + battle_get_luk (bl) / 3);
     sc_def_vit = 100 - (3 + battle_get_vit (bl) + battle_get_luk (bl) / 3);
     sc_def_mdef = 100 - (3 + battle_get_mdef (bl) + battle_get_luk (bl) / 3);
@@ -3313,13 +3311,13 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
         {
             int  heal = skill_calc_heal (src, skilllv);
             int  heal_get_jobexp;
-            int  skill;
             struct pc_base_job s_class;
 
             if (dstsd && dstsd->special_state.no_magic_damage)
                 heal = 0;       /* ‰©‹àå³ƒJ[ƒhiƒq[ƒ‹—Ê‚Oj */
             if (sd)
             {
+                int  skill;
                 s_class = pc_calc_base_job (sd->status.class);
                 if ((skill = pc_checkskill (sd, HP_MEDITATIO)) > 0) // ƒƒfƒBƒeƒCƒeƒBƒI
                     heal += heal * (skill * 2 / 100);
@@ -3344,17 +3342,17 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
         }
             break;
 
-        case ALL_RESURRECTION: /* ƒŠƒUƒŒƒNƒVƒ‡ƒ“ */
+        case ALL_RESURRECTION:
             if (bl->type == BL_PC)
             {
-                int  per = 0;
                 struct map_session_data *tsd = (struct map_session_data *) bl;
                 nullpo_retr (1, tsd);
                 if ((map[bl->m].flag.pvp) && tsd->pvp_point < 0)
-                    break;      /* PVP‚Å•œŠˆ•s‰Â”\ó‘Ô */
+                    break;      /* PVP */
 
                 if (pc_isdead (tsd))
-                {               /* €–S”»’è */
+                {
+                    int  per = 0;
                     clif_skill_nodamage (src, bl, skillid, skilllv, 1);
                     switch (skilllv)
                     {
@@ -3947,11 +3945,11 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
 
         case KN_BRANDISHSPEAR: /*ƒuƒ‰ƒ“ƒfƒBƒbƒVƒ…ƒXƒsƒA */
         {
-            int  c, n = 4, ar;
+            int  c, n = 4;
             int  dir = map_calc_dir (src, bl->x, bl->y);
             struct square tc;
             int  x = bl->x, y = bl->y;
-            ar = skilllv / 3;
+//            ar = skilllv / 3;
             skill_brandishspear_first (&tc, dir, x, y);
             skill_brandishspear_dir (&tc, dir, 4);
             /* ”ÍˆÍ‡C */
@@ -4518,9 +4516,10 @@ int skill_castend_nodamage_id (struct block_list *src, struct block_list *bl,
         case AM_POTIONPITCHER: /* ƒ|[ƒVƒ‡ƒ“ƒsƒbƒ`ƒƒ[ */
         {
             struct block_list tbl;
-            int  i, x, hp = 0, sp = 0;
+            int  x, hp = 0, sp = 0;
             if (sd)
             {
+                int  i;
                 if (sd == dstsd)
                 {               // cancel use on oneself
                     map_freeblock_unlock ();
@@ -6626,8 +6625,8 @@ int skill_unit_onplace (struct skill_unit *src, struct block_list *bl,
             else if (bl->type == BL_MOB && battle_config.mob_warpportal)
             {
                 int  m = map_mapname2mapid (sg->valstr);
-                struct mob_data *md;
-                md = (struct mob_data *) bl;
+//                struct mob_data *md;
+//                md = (struct mob_data *) bl;
                 mob_warp ((struct mob_data *) bl, m, sg->val2 >> 16,
                           sg->val2 & 0xffff, 3);
             }
@@ -7109,7 +7108,7 @@ int skill_castend_pos (int tid, unsigned int tick, int id,
                        int data __attribute__ ((unused)))
 {
     struct map_session_data *sd = map_id2sd (id) /*,*target_sd=NULL */ ;
-    int  range, maxcount;
+    int  range;
 
     nullpo_retr (0, sd);
 
@@ -7210,6 +7209,7 @@ int skill_castend_pos (int tid, unsigned int tick, int id,
 
     if (battle_config.pc_land_skill_limit)
     {
+        int  maxcount;
         maxcount = skill_get_maxcount (sd->skillid);
         if (maxcount > 0)
         {
@@ -8035,7 +8035,7 @@ int skill_use_id (struct map_session_data *sd, int target_id,
                   int skill_num, int skill_lv)
 {
     unsigned int tick;
-    int  casttime = 0, delay = 0, skill, range;
+    int  casttime = 0, delay = 0, range;
     struct map_session_data *target_sd = NULL;
     int  forcecast = 0;
     struct block_list *bl;
@@ -8378,6 +8378,7 @@ int skill_use_id (struct map_session_data *sd, int target_id,
         skill_status_change_end (&sd->bl, SC_CLOAKING, -1);
     if (casttime > 0)
     {
+        int  skill;
         sd->skilltimer =
             add_timer (tick + casttime, skill_castend_id, sd->bl.id, 0);
         if ((skill = pc_checkskill (sd, SA_FREECAST)) > 0)
@@ -8414,7 +8415,7 @@ int skill_use_pos (struct map_session_data *sd,
     struct block_list bl;
     struct status_change *sc_data;
     unsigned int tick;
-    int  casttime = 0, delay = 0, skill, range;
+    int  casttime = 0, delay = 0, range;
 
     nullpo_retr (0, sd);
 
@@ -8504,6 +8505,7 @@ int skill_use_pos (struct map_session_data *sd,
         skill_status_change_end (&sd->bl, SC_CLOAKING, -1);
     if (casttime > 0)
     {
+        int  skill;
         sd->skilltimer =
             add_timer (tick + casttime, skill_castend_pos, sd->bl.id, 0);
         if ((skill = pc_checkskill (sd, SA_FREECAST)) > 0)
@@ -8800,7 +8802,7 @@ int skill_devotion3 (struct block_list *bl, int target)
     // ƒNƒ‹ƒZ‚ª•à‚¢‚½‚Ì‹——£ƒ`ƒFƒbƒN
     struct map_session_data *md;
     struct map_session_data *sd;
-    int  n, r = 0;
+    int  r = 0;
 
     nullpo_retr (1, bl);
 
@@ -8812,6 +8814,7 @@ int skill_devotion3 (struct block_list *bl, int target)
 
     if (pc_checkskill (sd, CR_DEVOTION) + 6 < r)
     {                           // ‹–—e”ÍˆÍ‚ğ’´‚¦‚Ä‚½
+        int  n;
         for (n = 0; n < 5; n++)
             if (md->dev.val1[n] == target)
                 md->dev.val2[n] = 0;    // —£‚ê‚½‚ÍA…‚ğØ‚é‚¾‚¯
@@ -9175,7 +9178,6 @@ int skill_trap_splash (struct block_list *bl, va_list ap)
     struct skill_unit *unit;
     struct skill_unit_group *sg;
     struct block_list *ss;
-    int  i;
 
     nullpo_retr (0, bl);
     nullpo_retr (0, ap);
@@ -9198,13 +9200,16 @@ int skill_trap_splash (struct block_list *bl, va_list ap)
                                          BF_MISC, tick);
                 break;
             case 0x8f:         /* ƒuƒ‰ƒXƒgƒ}ƒCƒ“ */
-            case 0x98:         /* ƒNƒŒƒCƒ‚ƒA[ƒgƒ‰ƒbƒv */
+            case 0x98:
+            {
+                int  i;
                 for (i = 0; i < splash_count; i++)
                 {
                     skill_attack (BF_MISC, ss, src, bl, sg->skill_id,
                                   sg->skill_lv, tick,
                                   (sg->val2) ? 0x0500 : 0);
                 }
+            }
             case 0x97:         /* ƒtƒŠ[ƒWƒ“ƒOƒgƒ‰ƒbƒv */
                 skill_attack (BF_WEAPON, ss, src, bl, sg->skill_id,
                               sg->skill_lv, tick, (sg->val2) ? 0x0500 : 0);
@@ -9299,7 +9304,6 @@ int skill_status_change_active (struct block_list *bl, int type)
 int skill_status_change_end (struct block_list *bl, int type, int tid)
 {
     struct status_change *sc_data;
-    int  opt_flag = 0, calc_flag = 0;
     short *sc_count, *option, *opt1, *opt2, *opt3;
 
     nullpo_retr (0, bl);
@@ -9323,6 +9327,7 @@ int skill_status_change_end (struct block_list *bl, int type, int tid)
     if ((*sc_count) > 0 && sc_data[type].timer != -1
         && (sc_data[type].timer == tid || tid == -1))
     {
+        int  opt_flag = 0, calc_flag = 0;
 
         if (tid == -1)          // ƒ^ƒCƒ}‚©‚çŒÄ‚Î‚ê‚Ä‚¢‚È‚¢‚È‚çƒ^ƒCƒ}íœ‚ğ‚·‚é
             delete_timer (sc_data[type].timer, skill_status_change_timer);
@@ -9466,9 +9471,8 @@ int skill_status_change_end (struct block_list *bl, int type, int tid)
                 break;
             case SC_SELFDESTRUCTION:   /* ©”š */
             {
-                //©•ª‚Ìƒ_ƒ[ƒW‚Í0‚É‚µ‚Ä
-                struct mob_data *md = NULL;
-                if (bl->type == BL_MOB && (md = (struct mob_data *) bl))
+//                struct mob_data *md = NULL;
+                if (bl->type == BL_MOB && (struct mob_data *) bl)
                     skill_castend_damage_id (bl, bl, sc_data[type].val2,
                                              sc_data[type].val1, gettick (),
                                              0);
@@ -9958,11 +9962,11 @@ int skill_status_change_timer (int tid, unsigned int tick, int id, int data)
 
         case SC_DANCING:       //ƒ_ƒ“ƒXƒXƒLƒ‹‚ÌŠÔSPÁ”ï
         {
-            int  s = 0;
             if (sd)
             {
                 if (sd->status.sp > 0 && (--sc_data[type].val3) > 0)
                 {
+                    int  s = 0;
                     switch (sc_data[type].val1)
                     {
                         case BD_RICHMANKIM:    /* ƒjƒˆƒ‹ƒh‚Ì‰ƒ 3•b‚ÉSP1 */
@@ -11243,7 +11247,6 @@ struct skill_unit_group *skill_initunitgroup (struct block_list *src,
                                               int count, int skillid,
                                               int skilllv, int unit_id)
 {
-    int  i;
     struct skill_unit_group *group = NULL, *list = NULL;
     int  maxsug = 0;
 
@@ -11261,6 +11264,7 @@ struct skill_unit_group *skill_initunitgroup (struct block_list *src,
     }
     if (list)
     {
+        int  i;
         for (i = 0; i < maxsug; i++)    /* ‹ó‚¢‚Ä‚¢‚é‚à‚ÌŒŸõ */
             if (list[i].group_id == 0)
             {
@@ -11333,10 +11337,10 @@ struct skill_unit_group *skill_initunitgroup (struct block_list *src,
             case BD_RAGNAROK:  /* _X‚Ì‰©¨ */
             case CG_MOONLIT:   /* Œ–¾‚è‚Ìò‚É—‚¿‚é‰Ô‚Ñ‚ç */
             {
-                int  range = 1;
                 int  c = 0;
                 if (sd)
                 {
+                    const int  range = 1;
                     map_foreachinarea (skill_check_condition_use_sub,
                                        sd->bl.m, sd->bl.x - range,
                                        sd->bl.y - range, sd->bl.x + range,
@@ -11355,7 +11359,6 @@ struct skill_unit_group *skill_initunitgroup (struct block_list *src,
 int skill_delunitgroup (struct skill_unit_group *group)
 {
     struct block_list *src;
-    int  i;
 
     nullpo_retr (0, group);
     if (group->unit_count <= 0)
@@ -11371,6 +11374,7 @@ int skill_delunitgroup (struct skill_unit_group *group)
     group->alive_count = 0;
     if (group->unit != NULL)
     {
+        int  i;
         for (i = 0; i < group->unit_count; i++)
             if (group->unit[i].alive)
                 skill_delunit (&group->unit[i]);
@@ -11460,7 +11464,7 @@ struct skill_unit_group_tickset *skill_unitgrouptickset_search (struct
  */
 int skill_unitgrouptickset_delete (struct block_list *bl, int group_id)
 {
-    int  i, s = group_id % MAX_SKILLUNITGROUPTICKSET;
+    int  s = group_id % MAX_SKILLUNITGROUPTICKSET;
     struct skill_unit_group_tickset *set = NULL, *ts;
 
     nullpo_retr (0, bl);
@@ -11476,7 +11480,7 @@ int skill_unitgrouptickset_delete (struct block_list *bl, int group_id)
 
     if (set != NULL)
     {
-
+        int  i;
         for (i = 0; i < MAX_SKILLUNITGROUPTICKSET; i++)
             if ((ts =
                  &set[(i + s) % MAX_SKILLUNITGROUPTICKSET])->group_id ==
diff --git a/src/map/trade.c b/src/map/trade.c
index 40a762b..a2c7a97 100644
--- a/src/map/trade.c
+++ b/src/map/trade.c
@@ -106,11 +106,6 @@ void trade_tradeadditem (struct map_session_data *sd, int index, int amount)
 {
     struct map_session_data *target_sd;
     struct item_data *id;
-    int  trade_i;
-    int  trade_weight = 0;
-    int  free = 0;
-    int  c;
-    int  i;
 
     nullpo_retv (sd);
 
@@ -128,6 +123,12 @@ void trade_tradeadditem (struct map_session_data *sd, int index, int amount)
         else if (amount <= sd->status.inventory[index - 2].amount
                  && amount > 0)
         {
+            int  trade_i;
+            int  trade_weight = 0;
+            int  free = 0;
+            int  c;
+            int  i;
+
             // determine free slots of receiver
             for (i = 0; i < MAX_INVENTORY; i++)
             {
@@ -260,12 +261,12 @@ void trade_tradeok (struct map_session_data *sd)
 void trade_tradecancel (struct map_session_data *sd)
 {
     struct map_session_data *target_sd;
-    int  trade_i;
 
     nullpo_retv (sd);
 
     if ((target_sd = map_id2sd (sd->trade_partner)) != NULL)
     {
+        int  trade_i;
         for (trade_i = 0; trade_i < 10; trade_i++)
         {                       //give items back (only virtual)
             if (sd->deal_item_amount[trade_i] != 0)
@@ -312,7 +313,6 @@ void trade_tradecancel (struct map_session_data *sd)
 void trade_tradecommit (struct map_session_data *sd)
 {
     struct map_session_data *target_sd;
-    int  trade_i;
 
     nullpo_retv (sd);
 
@@ -345,6 +345,7 @@ void trade_tradecommit (struct map_session_data *sd)
                 }
                 sd->trade_partner = 0;
                 target_sd->trade_partner = 0;
+                int  trade_i;
                 for (trade_i = 0; trade_i < 10; trade_i++)
                 {
                     if (sd->deal_item_amount[trade_i] != 0)
@@ -415,11 +416,9 @@ void trade_tradecommit (struct map_session_data *sd)
 // [Jaxad0127]
 void trade_verifyzeny (struct map_session_data *sd)
 {
-    struct map_session_data *target_sd;
-
     nullpo_retv (sd);
 
-    if ((target_sd = map_id2sd (sd->trade_partner)) != NULL)
+    if (map_id2sd (sd->trade_partner) != NULL)
     {
         if (sd->deal_zeny > sd->status.zeny)
         {
-- 
2.1.0

